# --- Build Stage ---
FROM eclipse-temurin:24-jdk AS builder

# Install Maven
RUN apt-get update && apt-get install -y maven --no-install-recommends && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Needed for git-commit-id-plugin to get git info
COPY .git/ .git

# Copy all source files to build the application
COPY pom.xml .
COPY checkstyle/ checkstyle/
COPY client/ client/
COPY descriptors/ descriptors/
COPY js/ js/
COPY server/ server/
COPY util/ util/
COPY xsl/ xsl/

# Build the application and create the fat JAR
RUN mvn -B -DskipTests package

# --- Final Stage ---
FROM eclipse-temurin:24-jre

WORKDIR /app

# Create a non-root user to run the application
RUN useradd \
  --home-dir /nonexistent \
  --shell /sbin/nologin \
  --no-create-home \
  --uid 65532 \
  myuser

# Copy the fat JAR from the builder stage
COPY --from=builder /app/server/target/mod-reservoir-server-fat.jar app.jar

EXPOSE 8081

# Switch to the non-root user
USER myuser

# Run the application using a standard JVM
# JAVA_OPTS can be passed in during 'docker run'
CMD ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
